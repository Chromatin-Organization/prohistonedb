{% extends 'layouts/base.html.j2' %}

{% set RESULTS_PER_PAGE = 20 %}

{% block title %} {{siteName}} Search {% endblock title %}
{% block body %} class="search fluid-bg" {% endblock body %}

{% block header %}
    {% include 'includes/navigation_search.html.j2' %}
{% endblock header %}

{% block content %}

  <header>
    <div class="page-header pb-5">
      <div class="container">
        <div class="container mt-7">
            <div class="row">
                <div class="col-lg-8 my-auto">
                    <h2 class="text-white pt-3">Search results for {{ request.args.get('q') }}</h2>
                    {% if counts.total == 0 %}
                    <p class="mb-4 text-white">No results have been found.</p>
                    {% else %}
                    {% set results_min = (page - 1) * RESULTS_PER_PAGE + 1 %}
                    <p class="mb-4 text-white">Showing {{results_min}}-{{results_min + (results | length) - 1}} of {{counts.total}} results</p>
                    {% endif %}
                </div>
            </div>
        </div>
      </div>
    </div>
  </header>

  <div class="card card-body mx-3 mx-md-4">
     <div class="container my-3">
            <div class="row">
                <!-- sidebar left (search facets) -->
                <div id="facets-container" class="col-xl-3 col-lg-4 col-md-5 d-none d-md-block mt-3">
                    <h3>Filter by:</h3>
                    <form name="filters" method="GET" action="{{ url_for('search.index') }}">
                        <div class="row mt-3 filter-category">
                            <div class="label"><h6>Category</h6></div>
                            <div id="filter-category-wrapper" class="col-11 ps-0 mb-2">
                                <div class="form-check">
                                    {% for cat in counts.categories.index %}
                                    <div class="form-check ps-0">
                                        <input class="form-check-input" type="checkbox" name="cat" value="{{cat.name}}" id="categoryCheck{{loop.index}}">
                                        <label class="form-check-label" for="categoryCheck{{loop.index}}">
                                            {{cat}}
                                        </label>
                                        <span class="filter-num badge">
                                            {{counts.categories[cat]}}
                                        </span>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3 filter-lineage">
                            <div class="label"><h6>Lineage</h6></div>
                            {% for lin in counts.lineages.index %}
                            <div class="form-check col-10">
                                <input class="form-check-input" type="radio" name="tax" value="{{lin}}" id="lineageCheck{{loop.index}}">
                                <label class="form-check-label" for="lineageCheck1">
                                    {{lin}}
                                </label>
                                <span class="filter-num badge">
                                    {{counts.lineages[lin]}}
                                </span>
                            </div>
                            {% endfor %}
                        </div>

                        <div class="row mt-3 filter-sequence">
                            <div class="label"><h6>Sequence length</h6></div>
                            <div class="form-check col-10">
                                <div class="multislider slider-round"></div>
                            </div>
                            {# NOTE: set seqlHidden to disabled to prevent default values being used as a filter #}
                            <input class="form-check-input" type="hidden" name="seql" value=""  disabled />
                        </div>

                        <div class="row mt-5">
                            <div class="form-check col-10 text-center">
                                <button class="btn btn-secondary btn-sm btn-icon" type="submit">
                                    <span class="caption">Apply filters</span>
                                    <span class="material-icons-round">filter_alt</span>
                                </button>
                            </div>
                        </div>

                        {# !FIXME: temporarily disabled include file to test facets #}
                        {# include 'includes/search_hidden.html.j2' #}
                        <input type="hidden" name="filter" value="{{ request.args.get('filter') }}" />
                        <input type="hidden" name="q" value="{{ request.args.get('q') }}" />
                    </form>
                </div>
               

                 <div class="col-xl-9 col-lg-8 col-md-7 mt-3">
                    
                    {# * Applied filters block #}
                    {% if req_filters and (req_filters | length) > 0 %}
                        <div id="applied-filters-container" class="d-grid gap-2 d-md-block mb-4">
                            <h6 class="label">Filters:</h6>
                            {% for key in req_filters.keys() %}
                                {% for f in req_filters.getlist(key) %}
                                    <button type="button" class="btn btn-light btn-sm btn-icon mb-1" style="vertical-align: baseline" title="click to remove filter">
                                        <span class="caption">{{(key | field_name)}}: {{f}}</span>
                                        <span class="material-icons-round">disabled_by_default</span>
                                    </button>
                                {% endfor %}
                            {% endfor %}

                            <form name="reset-filters" method="GET" action="{{ url_for('search.index') }}" style="display: inline-block">
                                <button type="submit" class="btn btn-secondary btn-sm btn-icon mb-1" style="vertical-align: baseline">
                                    <span class="caption">Clear filters</span>
                                    <span class="material-icons-round">delete</span>
                                </button>
                            </form>
                        </div>
                    {% endif %}

                    {# * results view toggle #}
                    <div class="row">
                        <div class="col-12">
                            <div id="view-toggle-wrapper" class="float-end">
                                <a id="toggle-list" class="nav-link material-icons-round active" href="#" aria-selected="true" title="list view">reorder</a>
                                <a id="toggle-table" class="nav-link material-icons-round" href="#" title="table view">grid_on</a>
                            </div>
                        </div>
                    </div>
                    

                    {# * card view #}
                    {# single entry; loop this section #}
                    <div id="list-view">
                        {% for r in results %}
                        <div class="row mt-3 mb-3 px-3 py-3 rounded-3 result-item">
                            <h5><a href="{{ url_for('main.entry', uniprot_id=r.uniprot_id) }}">{{r.organism.name}} {{r.uniprot_id}}</a></h5>
                            <div class="row">
                                <div class="col-sm-3 label"><span>UniProt ID</span></div>
                                <div class="col-sm-9 value">
                                    <span class="mb-0">{{r.uniprot_id}}</span><span class="link text-nowrap"> <a href="https://www.uniprot.org/uniprotkb/{{r.uniprot_id}}/entry">go to UniProt</a></span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-3 label"><span>Category</span></div>
                                <div class="col-sm-9 value">
                                    <span class="mb-0">{{r.category.name}}</span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-3 label"><span>Protein</span></div>
                                <div class="col-sm-9 value">
                                    <span class="mb-0">{{r.protein_ids}}</span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-3 label"><span>Gene</span></div>
                                <div class="col-sm-9 value">
                                    <span class="mb-0">{{r.genes}}</span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-3 label"><span>Organism</span></div>
                                <div class="col-sm-9 value">
                                    <span class="mb-0 float-start me-2">{{r.organism.name}}</span><span class="link text-nowrap"><a href="{{ url_for('search.index', oid=r.organism.id) }}">Search this organism</a></span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-3 label"><span>Length</span></div>
                                <div class="col-sm-9 value">
                                    <span class="mb-0">{{r.sequence|length}} AA</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    {# * table view #}
                    {# * https://getbootstrap.com/docs/5.0/content/tables/ #}
                    <div id="table-view" class="col-12 d-none">
                        {% if (results | length) > 0 %}
                        <div id="table-wrapper">
                            <table id="bs-table" class="table table-striped table-hover table-responsive-md mt-3" data-toggle="table">
                                <thead>
                                    <tr>
                                        <th data-field="uniprotID" scope="col">UniProt ID</th>
                                        <th data-field="category" scope="col">Category</th>
                                        <th data-field="organism" scope="col">Protein</th>
                                        <th data-field="gene" scope="col">Gene</th>
                                        <th data-field="organism" scope="col">Organism</th>
                                        <th data-field="sequence" scope="col">Length</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for r in results %}
                                <tr>
                                    <td><strong><a href="{{ url_for('main.entry', uniprot_id=r.uniprot_id) }}">{{r.uniprot_id}}</a></strong></td>
                                    <td>{{r.category.name}}</td>
                                    <td>{{r.protein_ids}}</td>
                                    <td>{{r.genes}}</td>
                                    <td>{{r.organism.name}}</td>
                                    <td>{{r.sequence|length}} AA</td>
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            {% include "includes/pager.html.j2" %}

    </div>
  </div>
  {% endblock content %}

  {% block javascripts %}
    <script type="text/javascript">
        const seqlSlider = document.querySelector('.multislider');
        const seqlHidden = document.querySelector('input[name="seql"]');

        // initialize multirange slider
        {# TODO: initial slider max value should be updated with max sequence length in db #}
        noUiSlider.create(seqlSlider, {
            start: [0, 1200],
            step: 10,
            margin: 20, // min. distance between min-max
            connect: true,
            tooltips: wNumb({decimals: 0}), // requires wNumb library
            range: {
                'min': 0,
                'max': 1200 // get max seql from database
            }
        });

        // set hidden min-max values on slider "end" event
        // note: "set" event causes an infinite page update loop
        // "handle" arg is slider handle index
        seqlSlider.noUiSlider.on("end", (values, handle) => {
            // seqlHidden is disabled by default to prevent default values being used as a filter
            seqlHidden.disabled = false;
            seqlHidden.value = parseInt(values[0]) + "-" + parseInt(values[1]);
            {# * disabled onchange submit in favor of submit button ("apply filters") #}
            //document.querySelector("form[name='filters']").submit();
        });

        // intialize mini scrollbar for Category facet & table view
        const categoryScroll = new PerfectScrollbar("#filter-category-wrapper");
        if (document.getElementById("table-wrapper") !== null) {
            const tableScroll = new PerfectScrollbar("#table-wrapper");
        }


        window.addEventListener("DOMContentLoaded", () => {
            // change placeholder text to reflect we're searching within search results on the search results page
            // only show when there's an actual search query
            {% if req_filters is defined and (req_filters | length) > 0 %}
            document.querySelector('input[name="q"]').placeholder = "Search within results";
            {% endif %}


            // add eventListener to both toggle buttons; check for "active" class only when clicked
            const toggles = document.querySelectorAll("#view-toggle-wrapper .nav-link");
            toggles.forEach(toggle => {
                toggle.addEventListener("click", function(e) {
                    if (this.classList.contains("active")) {
                        return false;
                    } else {
                        document.getElementById("table-view").classList.toggle("d-none");
                        document.getElementById("list-view").classList.toggle("d-none");

                        document.querySelector("#view-toggle-wrapper .nav-link.active").classList.toggle("active");
                        this.classList.toggle("active"); // set inactive toggle to active
                    }
                    e.preventDefault();
                });
            });
           

            {# * set checkboxes to checked for each applied filter in query #}
            let filterArgs = {};
            {% if req_filters is defined and (req_filters | length) > 0 %}
                {% for key in req_filters.keys() %}
                    filterArgs["{{key}}"] = [];
                    {% for f in req_filters.getlist(key) %}
                        filterArgs.{{key}}.push("{{f}}");
                    {% endfor %}
                {% endfor %}
            {% endif %}

            const filters = document.querySelectorAll(".form-check-input");
            filters.forEach( filter => {
                filter.addEventListener("change", () => {
                    {# * disabled onchange submit in favor of submit button ("apply filters") #}
                    //document.querySelector("form[name='filters']").submit();
                });

                for (const key in filterArgs) {    
                    if (key === filter.name) {
                        filterArgs[key].forEach( val => {
                            // what if multiple seql filters applied sequentially?
                            if (key === "seql") {
                                const seqlRange = val.split("-").map(Number);
                                seqlSlider.noUiSlider.set([seqlRange[0], seqlRange[1]]);
                                seqlHidden.disabled = false;
                                seqlHidden.value = val;
                            } else {
                                if (val === filter.value) {
                                    filter.checked = true;
                                }
                            }
                        });
                    }
                }
            });
        });
    </script>
  {% endblock javascripts %}