{% extends 'layouts/base.html.j2' %}

{#*===== Constants =====*#}
{% set RESULTS_PER_PAGE = 20 %}

{#*===== Macros =====*#}
{% macro clear() %}{{url_for("search.index")}}{% endmacro %}
{% macro add_filters(new_filters) %} {# filters: a sequence of (field: str, value: str) pairs #}
    {% set filters = req_filters.copy() %}
    {% for (field, value) in new_filters %}
        {% do filters.add(field, value) %}
    {% endfor %}
    {{ url_for("search.index", **filters.to_dict(flat=False)) }}
{% endmacro %}
{% macro remove_filter(field, value) %} {# field: str, value: str #}
    {% set filters = req_filters.copy() %}
    {% set temp_list = filters.getlist(field) %}
    {% if value in temp_list %}
        {% do temp_list.remove(value) %}
        {% do filters.setlist(field, temp_list) %}
    {% endif %}
    {{ url_for("search.index", **filters.to_dict(flat=False)) }}
{% endmacro %}

{#*===== Header Block Implementations =====*#}
{% block title %} {{siteName}} | Search{% endblock title %}
{% block body %} class="search fluid-bg" {% endblock body %}

{% block header %}
    {% include 'includes/navigation_search.html.j2' %}
{% endblock header %}

{#*===== Main Content =====*#}
{% block content %}
  <!--* Page Header *-->
  <header>
    <div class="page-header pb-5">
      <div class="container">
        <div class="container mt-7">
            <div class="row">
                <div class="col-lg-8 my-auto">
                    {% if counts.total == 0 %}
                        <h2 class="text-white pt-3">No results have been found.</h2>
                    {% else %}
                        <h2 class="text-white pt-3">Search results</h2>
                        {% if counts.total == 1 %}
                            <p class="mb-4 text-white">1 result found</p>
                        {% else %}
                            {% set results_min = (page - 1) * RESULTS_PER_PAGE + 1 %}
                            <p class="mb-4 text-white">Showing {{results_min}}-{{results_min + (results | length) - 1}} of {{counts.total}} results</p>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
      </div>
    </div>
  </header>

  <div class="card card-body mx-3 mx-md-4">
     <div class="container my-3">
            <div class="row">
                <!-- Sidebar Left (search facets) -->
                <div id="facets-container" class="col-xl-3 col-lg-4 col-md-5 d-none d-md-block mt-3">
                    <h3>Filter by:</h3>
                    <form name="filters" method="GET" action="{{ url_for('search.index') }}">
                        <div class="row mt-3 filter-category">
                            <div class="label"><h6>Category</h6></div>
                            <div id="filter-category-wrapper" class="col-11 ps-0 mb-2">
                                <div class="form-check">
                                    {% for cat in categories.values() %}
                                        {% set count = counts.categories[cat.name] %}
                                        <div class="form-check ps-0{% if not count is defined %}{{' noitems'}}{% set count = 0 %}{% endif %}">
                                            <input class="form-check-input" type="checkbox" name="{{Field.CATEGORY_ID.search_name}}" value="{{cat.id}}" id="categoryCheck{{loop.index}}">
                                            <label class="form-check-label" for="categoryCheck{{loop.index}}">
                                                {{cat.short_name}}
                                            </label>
                                            <span class="filter-num badge">
                                                {{count}}
                                            </span>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3 filter-lineage">
                            <div class="label"><h6>Lineage - Superkingdoms</h6></div>
                            {# ? the list of superkingdoms is hard-coded for now. Do we want to keep it that way? #}
                            {% set superkingdoms = ["Archaea", "Bacteria", "Viruses"] %}
                            {% for superkingdom in superkingdoms %}
                            {% set count = counts.superkingdoms[superkingdom] %}
                            <div class="form-check col-10{% if not count is defined %}{{' noitems'}}{% set count = 0 %}{% endif %}">
                                <input class="form-check-input" type="checkbox" name="{{Field.LINEAGE_SUPERKINGDOM.search_name}}" value="{{superkingdom}}"  id="lineageCheck{{loop.index}}">
                                <label class="form-check-label" for="lineageCheck{{loop.index}}">
                                    {{superkingdom}}
                                </label>
                                <span class="filter-num badge">
                                    {{count}}
                                </span>
                            </div>
                            {% endfor %}
                            
                            <div class="form-check col-10{% if not counts.superkingdoms[None] is defined %}{{' noitems'}}{% endif %}">
                                <input class="form-check-input" type="checkbox" name="{{Field.LINEAGE_SUPERKINGDOM.search_name}}" value="" id="lineageCheck{{(superkingdoms | length)+1}}">
                                <label class="form-check-label" for="lineageCheck{{(superkingdoms | length)+1}}">
                                    Undefined
                                </label>
                                <span class="filter-num badge">
                                    {% if counts.superkingdoms[None] is defined %}{{counts.superkingdoms[None]}}{%else%}0{%endif%}
                                </span>
                            </div>
                        </div>

                        <div class="row mt-3 filter-sequence">
                            <div class="label"><h6>Sequence length</h6></div>
                            <div class="form-check col-10">
                                <div class="multislider slider-round"></div>
                            </div>
                            {# NOTE: set seqlHidden to disabled to prevent default values being used as a filter #}
                            <input class="form-check-input" type="hidden" name="{{Field.SEQUENCE_LEN.search_name}}" value="" disabled />
                        </div>

                        <div class="row mt-5">
                            <div class="form-check col-10 text-center">
                                <button class="btn btn-secondary btn-sm btn-icon" type="submit">
                                    <span class="material-icons-round">filter_alt</span>
                                    <span class="caption">Apply filters</span>
                                </button>
                            </div>
                        </div>

                        {% for field in req_filters %}
                            {% if not field in Field.facet_fields() %}
                                {% for value in req_filters.getlist(field) %}
                                    <input type="hidden" name="{{field}}" value="{{value}}" />
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                    </form>
                </div>

                 <div class="col-xl-9 col-lg-8 col-md-7 mt-3">
                    {# * Applied filters block #}
                    {% if req_filters and (req_filters | length) > 0 %}
                        <div id="applied-filters-container" class="d-grid gap-2 d-md-block mb-5">
                            {# <h6 class="label">Filters:</h6> #}
                            {% for field in req_filters.keys() %}
                                {% for value in req_filters.getlist(field) %}
                                    <button type="button" class="btn btn-light btn-sm btn-icon mb-1" style="vertical-align: baseline" title="click to remove filter" onClick="location.href='{{remove_filter(field, value) | trim}}'">
                                        {% if field == Field.CATEGORY_ID %}
                                        <span class="caption">{{(field | field_name)}}: {{value}} ({{categories[value | int].short_name}})</span>
                                        {% else %}
                                        <span class="caption">{{(field | field_name)}}: {{value}}</span>
                                        {% endif %}
                                        <span class="material-icons-round">disabled_by_default</span>
                                    </button>
                                {% endfor %}
                            {% endfor %}

                            <button type="submit" class="btn btn-secondary btn-sm btn-icon mb-1" style="vertical-align: baseline" onClick="location.href='{{clear()|trim}}'">
                                <span class="material-icons-round">delete</span>
                                <span class="caption">Clear filters</span>
                            </button>
                        </div>
                    {% endif %}

                    {# * results view toggle #}
                    <div class="row">
                        <div class="col-12">
                            <div id="view-facets-wrapper" class="float-start d-sm-block d-md-none">
                                <a id="offFacetsBtn" class="nav-link material-icons-round active" href="#"  data-bs-toggle="offcanvas"
                                data-bs-target="#offFacets" aria-controls="facets" title="Show filter options">tune</a>
                            </div>
                            
                            <div id="download-button-wrapper" class="float-start">
                                <button id="downloadSelectedBtn" class="btn btn-sm btn-icon btn-outline-secondary disabled" title="Download selected items" data-bs-toggle="modal" data-bs-target="#progressModal">
                                    <span class="material-icons-round">download</span>
                                    <span class="caption">Download</span>
                                </button>
                                <button id="addToBasketBtn" class="btn btn-sm btn-icon btn-outline-secondary disabled" title="Add selected items to download basket" onclick="addToBasket()">
                                    <span class="material-icons-round">shopping_basket</span>
                                    <span class="caption">Add to basket</span>
                                </button>
                            </div>

                            <div id="view-toggle-wrapper" class="float-end">
                                <a id="toggle-list" class="nav-link material-icons-round active" href="#" aria-selected="true" title="list view">reorder</a>
                                <a id="toggle-table" class="nav-link material-icons-round" href="#" title="table view">grid_on</a>
                            </div>
                        </div>
                    </div>
                    

                    {# * card view #}
                    <div id="list-view" class="results">
                        <div class="form-check pe-0" id="download_select_toggle_wrapper">
                            <input class="form-check-input" type="checkbox" id="download_select_toggle" title="Select/deselect all items on this page">
                            <label class="form-check-label">Select all</label>
                        </div>

                        {% for r in results %}
                        <div class="card result-item my-4">
                            <div class="row mx-0">
                                <div class="status py-3 text-center">
                                    <div class="form-check mx-auto">
                                        <input class="form-check-input select" type="checkbox" name="{{Field.UNIPROT_ID.search_name}}" value="{{r.uniprot_id}}" title="Select for download">
                                        <span class="material-icons-round d-none" title="This item is already in your basket">shopping_basket</span>
                                    </div> 
                                </div>
                                <div class="info px-0 py-3">
                                    <h5><a href="{{ url_for('main.entry', uniprot_id=r.uniprot_id) }}">{{r.organism.name}} {{r.uniprot_id}}</a></h5>
                                    <div class="row">
                                        <div class="col-md-4 col-lg-3 label"><span>UniProt ID</span></div>
                                        <div class="col-md-8 col-lg-9 value">
                                            <span class="mb-0">{{r.uniprot_id}}</span><span class="ext-link text-nowrap"> <a href="https://www.uniprot.org/uniprotkb/{{r.uniprot_id}}/entry">go to UniProt</a></span>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 col-lg-3 label"><span>Category</span></div>
                                        <div class="col-md-8 col-lg-9 value">
                                            <span class="mb-0">
                                            {% if r.category.name != 'Undefined' %}
                                                <a href="{{ url_for('categories.with_id', id=r.category.id) }}">{{r.category.name}}</a>
                                            {% else %}
                                                {{r.category.name}}
                                            {% endif %}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 col-lg-3 label"><span>Protein IDs</span></div>
                                        <div class="col-md-8 col-lg-9 value">
                                            <span class="mb-0">{{r.protein_ids|join(", ")}}</span>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 col-lg-3 label"><span>Gene names</span></div>
                                        <div class="col-md-8 col-lg-9 value">
                                            {% if r.gene_names %}
                                            <span class="mb-0">{{r.gene_names|join(", ")}}</span>
                                            {% else %}
                                            <span class="mb-0"> - </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                     <div class="row">
                                        <div class="col-md-4 col-lg-3 label"><span>Protein names</span></div>
                                        <div class="col-md-8 col-lg-9 value">
                                            {% if r.protein_names %}
                                            <span class="mb-0">{{r.protein_names|join(", ")}}</span>
                                            {% else %}
                                            <span class="mb-0"> - </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 col-lg-3 label"><span>Organism</span></div>
                                        <div class="col-md-8 col-lg-9 value">
                                            <span class="mb-0 float-start me-2">{{r.organism.name}}</span><span class="link text-nowrap"><a href="{{ url_for('search.index', oid=r.organism.id) }}">Search this organism</a></span>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 col-lg-3 label"><span>Length</span></div>
                                        <div class="col-md-8 col-lg-9 value">
                                            <span class="mb-0">{{r.sequence|length}} AA</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    {# * table view #}
                    <div id="table-view" class="col-12 results d-none">
                        {% if (results | length) > 0 %}
                        <div id="table-wrapper">
                            <table id="bs-table" class="table table-striped table-hover table-responsive-md mt-3" data-toggle="table">
                                <thead>
                                    <tr>
                                        <th data-field="uniprotID" scope="col">
                                            <div class="form-check ps-2">
                                                <input class="form-check-input" type="checkbox" id="download_select_toggle" title="Select/deselect all items on this page">
                                                <label for="download_select_toggle" aria-label="Select/deselect all items on this page"></label>
                                            </div>
                                        </th>
                                        <th data-field="uniprotID" scope="col">UniProt ID</th>
                                        <th data-field="category" scope="col">Category</th>
                                        <th data-field="organism" scope="col">Protein</th>
                                        <th data-field="gene_name" scope="col">Gene name</th>
                                        <th data-field="organism" scope="col">Organism</th>
                                        <th data-field="sequence" scope="col">Length</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for r in results %}
                                <tr>
                                    <td>
                                        <div class="form-check ps-2">
                                            <input class="form-check-input select" type="checkbox" name="{{Field.UNIPROT_ID.search_name}}" value="{{r.uniprot_id}}"" title="Select for download">
                                            <span class="material-icons-round d-none" title="This item is already in your basket">shopping_basket</span>
                                        </div>        
                                    </td>
                                    <td><strong><a href="{{ url_for('main.entry', uniprot_id=r.uniprot_id) }}">{{r.uniprot_id}}</a></strong></td>
                                    <td>{{r.category.name}}</td>
                                    <td>{{r.protein_ids|join(", ")}}</td>
                                    {% if r.gene_names %}
                                    <td>{{r.gene_names|join(", ")}}</td>
                                    {% else %}
                                    <td> - </td>
                                    {% endif %}
                                    <td>{{r.organism.name}}</td>
                                    <td>{{r.sequence|length}} AA</td>
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            {% include "includes/pager.html.j2" %}

    </div>
  </div>

    <div class="offcanvas offcanvas-start pt-3 pb-2 py-lg-0" id="offFacets">
        <div class="offcanvas-header">
            <button class="btn btn-close px-2 pt-3 mb-0 material-icons-round">close</button>
        </div>
        <div class="offfacets-body container">
        </div>
    </div>

    {% include "includes/spinner_modal.html.j2" %}

  {% endblock content %}

  {% block javascripts %}
    <script type="text/javascript">
        {# * Session cookie functions * #}
        async function addToBasket() {
            const selectors = document.querySelectorAll(".results:not(.d-none) input.select")

            let uids = []
            selectors.forEach(selector => {
                if (selector.checked) {
                    uids.push(selector.value)
                }

                // Reset checked state
                selector.checked = false
            })

            try {
                const response = await fetch("{{url_for('session.cart_items')}}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(uids)
                })

                if (!response.ok) {
                    throw new Error("Did not receive a succesfull request response.")
                }
            } catch(error) {
                console.error("There has been a problem updating the 'download cart':", error)
            }

            reloadBasket()
        }

        {# * offcanvas Facets * #}
        const offFacets = document.querySelector("#offFacets")
        const offFacetsClose = document.querySelector("#offFacets .btn-close")
    
        offFacetsClose.addEventListener("click", function() {
            const openedCanvas = bootstrap.Offcanvas.getInstance(offFacets)
            openedCanvas.hide()
        })

        {# * Facets Sidebar * #}
        // small screen facets sidebar functionality
        {# TODO: update on window resize #}
        const facetsSidebar = document.querySelector("#facets-container")
        const offFacetsBtn = document.querySelector("#offFacetsBtn")
        const offFacetsBody = document.querySelector(".offfacets-body")

        offFacetsBtn.addEventListener("click", function() {
            offFacetsBody.append(facetsSidebar)
            facetsSidebar.classList.remove("d-none")
            facetsSidebar.classList.add("col-12") // should be removed again for larger screen sizes
        })

        // mobile/offcanvas facets sidebar might need a scrollbar
        //const offFacetsScroll = new PerfectScrollbar("#offFacets");

        {# * Sequence Length Slider * #}
        const seqlSlider = document.querySelector('.multislider')
        const seqlHidden = document.querySelector('input[class="form-check-input"][name="{{Field.SEQUENCE_LEN.search_name}}"]')

        // initialize multirange slider
        noUiSlider.create(seqlSlider, {
            start: [0, {{counts.max_seq_len}}],
            step: 10,
            margin: 20, // min. distance between min-max
            connect: true,
            tooltips: wNumb({decimals: 0}), // requires wNumb library
            range: {
                'min': 0,
                'max': {{max_seq_len}} // get max seql from database
            }
        })

        // set hidden min-max values on slider "end" event
        // note: "set" event causes an infinite page update loop
        // "handle" arg is slider handle index
        seqlSlider.noUiSlider.on("end", (values, handle) => {
            // seqlHidden is disabled by default to prevent default values being used as a filter
            seqlHidden.disabled = false
            seqlHidden.value = parseInt(values[0]) + "-" + parseInt(values[1])
            {# * disabled onchange submit in favor of submit button ("apply filters") #}
            //document.querySelector("form[name='filters']").submit()
        })

        // intialize mini scrollbar for Category facet & table view
        const categoryScroll = new PerfectScrollbar("#filter-category-wrapper")
        if (document.getElementById("table-wrapper") !== null) {
            const tableScroll = new PerfectScrollbar("#table-wrapper")
        }

        {# * Search Bar * #}
        // change placeholder text to reflect we're searching within search results on the search results page
        // only show when there's an actual search query
        {% if req_filters is defined and (req_filters | length) > 0 %}
        document.querySelector('input[name="q"]').placeholder = "Search within results"
        {% endif %}

        {# * Bulk Downloads * #}
        const downloadButton = document.querySelector("#downloadSelectedBtn")
        const addToBasketButton = document.querySelector("#addToBasketBtn")
        const downloadSelectToggles = document.querySelectorAll("#download_select_toggle")
        const downloadSelectors = document.querySelectorAll(".results input.select")

        // Changes the button between active and disabled.
        function updateDownloadButton() {
            const selectors = document.querySelectorAll(".results:not(.d-none) input.select")
            let active = 0
            
            selectors.forEach(selector => {
                if (selector.checked)
                    active += 1
            })

            if (active === 0) {
                downloadButton.classList.add("disabled")
                downloadButton.classList.add("btn-outline-secondary")
                downloadButton.classList.remove("btn-primary")

                addToBasketButton.classList.add("disabled")
                addToBasketButton.classList.add("btn-outline-secondary")
                addToBasketButton.classList.remove("btn-primary")
            } else if (active > 0) {
                downloadButton.classList.remove("disabled")
                downloadButton.classList.remove("btn-outline-secondary")
                downloadButton.classList.add("btn-primary")

                addToBasketButton.classList.remove("disabled")
                addToBasketButton.classList.remove("btn-outline-secondary")
                addToBasketButton.classList.add("btn-primary")
            } else {
                throw new Error("This should be unreachable. Can't select a negative number of checkboxes.")
            }
        }

        // Bulk download button functionality
        downloadButton.addEventListener("click", function(e) {
            const selectors = document.querySelectorAll(".results:not(.d-none) input.select")
            let uids = []
            
            selectors.forEach(selection => {
                if (selection.name === "uid" && selection.checked) {
                    uids.push("uid=" + selection.value)
                }

                // Reset checked state
                selection.checked = false
            })

            // Reset download button status
            updateDownloadButton()
            // Reset select all toggle
            document.querySelector("#download_select_toggle").checked = false

            if (uids.length > 0) {
                window.location = "{{url_for('main.download')}}?" + uids.join('&')
            } else {
                window.location = "{{url_for('main.download')}}"
            }
        })

        // Select all button functionality.
        downloadSelectToggles.forEach(selectToggle => {
            selectToggle.addEventListener("change", function() {
                const otherSelectToggle = document.querySelector(".results.d-none #download_select_toggle")

                if (this.checked === true) {
                    otherSelectToggle.checked = true
                    downloadSelectors.forEach( selector => {
                        selector.checked = true
                    })
                } else {
                    otherSelectToggle.checked = false
                    downloadSelectors.forEach( selector => {
                        selector.checked = false
                    })
                }

                // Reset download button status
                updateDownloadButton()
            })
        })

        // Add functionality for the selection boxes including:
        //   * Syncing across views
        //   * Updating the download button when necessary.
        //   * Updating the Select all checkboxes when necessary.
        downloadSelectors.forEach( selector => {
            selector.addEventListener("change", function() {
                const otherSelectors = document.querySelectorAll(".results.d-none input.select")
                let active = 0

                otherSelectors.forEach(selector => {
                    if (selector.value === this.value)
                        selector.checked = this.checked
                    
                    if (selector.checked)
                        active += 1
                })

                const allSelected = otherSelectors.length === active
                downloadSelectToggles.forEach(selectToggle => {
                    if (allSelected)
                        selectToggle.checked = true
                    else if (selectToggle.checked && !self.checked)
                        selectToggle.checked = false
                })

                updateDownloadButton()
            })
        })

        // close progress/spinner modal when File save dialog opens
        window.addEventListener("focus", () => {
            clearSpinnerModal()
        })

        {# * View toggles * #}
        // add eventListener to both toggle buttons; check for "active" class only when clicked
        const toggles = document.querySelectorAll("#view-toggle-wrapper .nav-link")
        toggles.forEach(toggle => {
            toggle.addEventListener("click", function(e) {
                if (this.classList.contains("active")) {
                    return false
                } else {
                    document.getElementById("table-view").classList.toggle("d-none")
                    document.getElementById("list-view").classList.toggle("d-none")

                    document.querySelector("#view-toggle-wrapper .nav-link.active").classList.toggle("active")
                    this.classList.toggle("active") // set inactive toggle to active
                }
                e.preventDefault()
            })
        })
        
        {# * Facets * #}
        // set checkboxes to checked for each applied filter in query 
        let filterArgs = {}
        {% if req_filters is defined and (req_filters | length) > 0 %}
            {% for key in req_filters.keys() %}
                filterArgs["{{key}}"] = []
                {% for f in req_filters.getlist(key) %}
                    filterArgs.{{key}}.push("{{f}}")
                {% endfor %}
            {% endfor %}
        {% endif %}

        const filters = document.querySelectorAll("#facets-container .form-check-input")
        filters.forEach( filter => {
            for (const key in filterArgs) {    
                if (key === filter.name) {
                    filterArgs[key].forEach( val => {
                        // what if multiple seql filters applied sequentially?
                        if (key === "{{Field.SEQUENCE_LEN.search_name}}") {
                            const seqlRange = val.split("-").map(Number)
                            seqlSlider.noUiSlider.set([seqlRange[0], seqlRange[1]])
                            seqlHidden.disabled = false
                            seqlHidden.value = val
                        } else {
                            if (val === filter.value) {
                                filter.checked = true
                            }
                        }
                    })
                }
            }
        })
    </script>
  {% endblock javascripts %}