{% extends 'layouts/base.html.j2' %}

{% macro reload(multimer, rank) %}{{url_for('main.entry', uniprot_id=entry.uniprot_id, multimer=multimer.value, rank=rank)}}{% endmacro %}
{% macro img_path(suffix) %}https://prohistonedb.universiteitleiden.nl/{{(entry.get_path(multimer) / entry.uniprot_id).as_posix()+suffix}}{% endmacro %}

{% block title %} {{siteName}} | {{uniprotID}}{% endblock title %}

{% block molstar %}
    <script src="{{ url_for('static', filename = 'assets/js/custom/molstar.min.js' )}}" type="text/javascript"></script>
    <link href="{{ url_for('static', filename = 'assets/css/molstar.min.css' )}}" rel="stylesheet">
{% endblock molstar %}

{% block body %} class="entry fluid-bg" {% endblock body %}

{% block header %}
    {% include 'includes/navigation_search.html.j2' %}
{% endblock header %}

{% block content %}

<header>
    <div class="page-header pb-5">
        <div class="container">

            <div class="container mt-7">
                <div class="row">
                    <div class="col-12">
                        <h2 class="text-white pt-3">{{entry.uniprot_id}}</h2>
                    </div>
                </div>
                <div id="information" class="row opacity-8">
                    <div class="col-12">
                        <h3 class="text-white pt-3">Information</h3>

                        <div class="pb-2 row">
                            <div class="col-sm-3 label"><span>Source organism</span></div>
                            <div class="col-sm-9 value">
                                <span class="mb-0 float-start me-2">{{entry.organism.name}}</span><span class="link text-nowrap"><a href="{{ url_for('search.index', oid=entry.organism.id) }}">Search this organism</a></span>
                            </div>
                        </div>
                        <div class="pb-2 row">
                            <div class="col-sm-3 label"><span>Category</span></div>
                            <div class="col-sm-9 value">
                                <span class="mb-0 float-start me-2">{{entry.category.name}}</span><span class="link text-nowrap"><a href="{{ url_for('search.index', cid=entry.category.id) }}">Search this category</a></span>
                            </div>
                        </div>
                        <div class="pb-2 row">
                            <div class="col-sm-3 label"><span>Gene</span></div>
                            <div class="col-sm-9 value">
                                {% if entry.genes %}
                                <span class="mb-0">{{entry.genes|join(",")}}</span>
                                {% else %}
                                <span class="mb-0"> - </span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="pb-2 row">
                            <div class="col-sm-3 label"><span>Sequence length</span></div>
                            <div class="col-sm-9 value">
                                <span class="mb-0">{{entry.sequence|length}} AA</span>
                            </div>
                        </div>
                        <div class="pb-2 row">
                            <div class="col-sm-3 label"><span>UniProt</span></div>
                            <div class="col-sm-9 value">
                                <span class="mb-0 float-start me-2">{{entry.uniprot_id}}</span><span class="ext-link text-nowrap"> <a href="https://www.uniprot.org/uniprotkb/{{entry.uniprot_id}}/entry">go to UniProt</a></span>
                            </div>
                        </div>
                        <div class="pb-1 row">
                            <div class="col-sm-3 label"><span>Lineage</span></div>
                            <div class="col-sm-9 value">
                                <span class="mb-0">
                                    <ul class="lineage-path">
                                        {% for lin in entry.lineage %}
                                            {% if not lin.hidden %}
                                                <li><a href="https://uniprot.org/taxonomy/{{lin.id}}">{{lin.name}}</a></li>
                                            {% endif %}
                                        {% endfor %}
                                    </ul>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div><!-- end page header -->
</header>

<div class="card card-body mx-3 mx-md-4 pb-0">
    <section class="my-3">
        {% if multimer is defined %}
            <!-- structure / views options -->
            <div class="container">              
                <div class="row py-3 mt-3">
                    <div class="col-12 start-0">
                        
                        <div class="dropdown float-start me-2">
                                <a class="btn btn-sm btn-primary dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-bs-toggle="dropdown" aria-expanded="false">
                                    {{multimer.value}}
                                </a>

                                <ul id="select_multimer" class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                                    {# * For now every multimer has a seperate call to the backend. #}
                                    {# ? Since all required information should be available from the first call, we may want to ovload this to the client in the future. #}
                                    {# ? Maybe add something to indicate the default option? #}
                                    {% for mult in entry.multimers %}
                                        <li><a class="dropdown-item" href="{{ reload(mult,rank) }}">{{mult.value}}</a></li>
                                    {% endfor %}
                                </ul>
                        </div>

                        <div class="dropdown float-start">
                            <a class="btn btn-sm btn-secondary dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-bs-toggle="dropdown" aria-expanded="false">
                                Rank {{rank}}
                            </a>

                            <ul id="select_rank" class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                                {% for n in range(5) %}
                                    <li><a class="dropdown-item option-{{n + 1}}" href="{{ reload(multimer, (n + 1)) }}">Rank {{n + 1}} - Model {{entry.get_model_id(multimer, n + 1)}}</a></li>
                                {% endfor %}
                            </ul>
                        </div>

                        <div class="dropdown float-end">
                            <a class="btn btn-sm btn-secondary btn-download float-end" href="https://prohistonedb.universiteitleiden.nl/data/zips/{{entry.uniprot_id}}.zip" role="button" title="Download all structure data (zipped)">
                                <span class="caption">Download</span>
                                <span class="material-icons-round">download</span>
                            </a>
                        </div>
                    </div>

                </div>
            </div>

            <div class="container my-3">
                <div class="row">
                    <!-- sidebar left -->
                    <div class="col-lg-3 d-none d-lg-block">
                        <h3>3D viewer</h3>
                        <div class="viewer-legend py-3">
                            <h6>Model confidence:</h6>
                            <div>
                                <span class="legend-color" style="background-color: rgb(0, 83, 214);">&nbsp;</span>
                                <span class="legend-label">Very high (pLDDT &gt; 90)</span>
                            </div>
                            <div>
                                <span class="legend-color" style="background-color: rgb(101, 203, 243);">&nbsp;</span>
                                <span class="legend-label">Confident (90 &gt; pLDDT &gt; 70)</span>
                            </div>
                            <div>
                                <span class="legend-color" style="background-color: rgb(255, 219, 19);">&nbsp;</span>
                                <span class="legend-label">Low (70 &gt; pLDDT &gt; 50)</span>
                            </div>
                            <div>
                                <span class="legend-color" style="background-color: rgb(255, 125, 69);">&nbsp;</span>
                                <span class="legend-label">Very low (pLDDT &lt; 50)</span>
                            </div>
                        </div>
                        <p>
                            AlphaFold produces a per-residue confidence score (pLDDT) between 0 and 100. Some regions below 50 pLDDT may be unstructured in isolation.
                        </p>
                    </div>
                    <div class="col-lg-9">
                        <div class="row mt-3">
                            <div id="viewer-container" class="col-lg-12"><!-- mask right sidebar Molstar viewer -->
                                <div id="mspViewer">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row my-5">
                    <div class="col-lg-3">
                        <h3>Predicted aligned error</h3>
                    </div>
                    <div class="col-lg-9">
                        <div class="row mt-3">
                            <div id="pae-view" class="columns medium-9">
                                <div id="pae-container" class="r{{rank | string}} mx-auto" style="background-image: url('{{ img_path('_PAE.png') }}')">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row my-5">
                    <div class="col-lg-3">
                        <h3>Sequence coverage &<br/>local confidence (LDDT)</h3>
                    </div>
                    <div class="col-lg-9">
                        <div class="row mt-3">
                            <div class="w-100">
                                <div id="coverage-container" class="mx-auto w-100">
                                    <img src="{{ img_path('_coverage.png') }}" class="w-100 h-auto">
                                </div>
                                <div id="plddt-container" class="mx-auto w-100">
                                    <img src="{{ img_path('_plddt.png') }}" class="w-100 h-auto">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row my-5">
                    <div class="col-lg-3">
                        <h3>Skylign Logo</h3>
                        <p>{{url_for('static', filename=(entry.category.static_logo_path | string))}}</p>
                    </div>
                    {# <div class="col-lg-9">
                        <div class="row mt-3">
                            <div id="pae-view" class="columns medium-9">
                                <div id="pae-container" class="mx-auto" style="background-image: url('{{url_for('static', filename=(entry.category.static_logo_path.as_posix() | string))}}')">
                                </div>
                            </div>
                        </div>
                    </div> #}
                </div>

                <div class="row my-5">
                    <div class="col-lg-3">
                        <h3>Last updated</h3>
                    </div>
                    <div class="col-lg-9">
                        <div class="row mt-2">
                            <p>This entry has been updated for the last time on {{entry.last_updated.date() | string}}.</p>
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            {# TODO: Add better formatting. #}
            <div class="container">              
                <div class="row py-3 mt-3">
                    <div class="col-12">
                        <h3>No structures found for this histone.</h3>
                    </div>
                </div>
            </div>
        {% endif %}
    </section>

    <section id="attribution" class="bg-gradient-dark mx-n3">
        <div class="container">
            <div class="row">
                <div class="col-md-10 text-start mb-5 mt-5">
                    {% include "contents/attribution.html" %}
                </div>
            </div>
        </div>
    </section>

    {#
    <section class="my-3">
        <div class="container">              
            <div class="row py-3 mt-3">
                <div class="col-12">
                    <h3>Disclaimer etc.</h3>
                </div>
            </div>
        </div>
    </section>
    #}
</div>
{% endblock content %}

{% block javascripts %}
    {% if multimer is defined %}
        <script>
            const mspViewer = document.querySelector("#mspViewer");
            const modelURL = "https://prohistonedb.universiteitleiden.nl/{{entry.get_cif_path(multimer, rank).as_posix()}}";

            molstar.Viewer.create('mspViewer', {
                // https://molstar.org/docs/plugin/
                // https://molstar.org/viewer-docs/query-parameters/
                // https://github.com/molstar/pdbe-molstar/blob/master/index.html

                layoutIsExpanded: false, // expand to window
                layoutShowControls: true, // rightsidebar & sequence panel
                layoutShowRemoteState: false,
                layoutShowSequence: true,
                layoutShowLog: false,
                layoutShowLeftPanel: false, // adds "msp-layout-hide-left" class
                alphafoldView: true,

                // show/hide viewport buttons
                viewportShowExpand: false,
                viewportShowSelectionMode: false,
                viewportShowAnimation: false,
                viewportShowControls: false // control panel (= rightsidebar & sequence panel) toggle
            }).then(viewer => {
                viewer.loadStructureFromUrl(modelURL, format='mmcif'); // mmcif or pdb

                const mspLayoutHide = document.querySelector(".msp-layout-hide-left.msp-layout-hide-bottom");
                mspViewer.style.width = '100%';
                mspLayoutHide.classList.add("msp-layout-hide-right");
            });
        </script>
    {% endif %}
{% endblock javascripts %}